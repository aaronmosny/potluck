<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Clan Shangri-La Camp Meals</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>

<style>
body { font-family: system-ui, -apple-system, sans-serif; background:#f5f7fa; margin:0; padding:12px; }
h1,h2,h3,h4 { margin-top:0; }
button { padding:8px 12px; font-size:1em; cursor:pointer; border:none; border-radius:6px; }
button.secondary { background:#6b7280; color:#fff; }
button.danger { background:#dc2626; color:#fff; }
button.addItem { background:#4f46e5; color:#fff; font-weight:bold; }

.event-card, .day {
  background:#fff;
  border-radius:12px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
}

.event-actions { display:flex; gap:8px; margin-top:10px; }
.hidden { display:none; }

.slot { border-left:4px solid #4f46e5; padding-left:12px; margin-top:16px; }

.meal-theme { margin:8px 0 12px; }
.meal-theme input {
  width:100%;
  padding:8px;
  border-radius:6px;
  border:none;
  background:#e5e7eb;
  font-size:.95em;
}

.item {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin:6px 0;
  padding:10px;
  background:#f9fafb;
  border-radius:8px;
}

.item-content { display:flex; gap:12px; flex:1; }
.item.unclaimed { border:2px solid #dc2626; }

.dragging { opacity:.4; }
.drop-target { background:#e0e7ff; }

.addItemContainer {
  display:flex;
  gap:8px;
  margin-top:8px;
}

.addItemContainer input {
  flex:1;
  padding:6px;
  border-radius:6px;
  border:none;
  background:#e5e7eb;
}

.admin { font-size:.85em; color:#6b7280; margin:10px 0; }
</style>
</head>

<body>

<h1>Clan Shangri-La Camp Meals</h1>
<button id="newEventBtn">New Event</button>

<div id="events"></div>
<div id="potluck" class="hidden"></div>

<script>
const SUPABASE_URL = "https://amayopmpqvkqbdlkbkog.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtYXlvcG1wcXZrcWJkbGtia29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MTM3NTQsImV4cCI6MjA4NzM4OTc1NH0.7k5eEc3RY4COJMIvDtffwI2eGalY5k0CWARAEkuyJ-M";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

function uid(){ return Math.random().toString(36).slice(2); }

const eventsDiv = document.getElementById('events');
const potluckDiv = document.getElementById('potluck');
const newEventBtn = document.getElementById('newEventBtn');

let eventsList = [];
let currentEvent = null;

/* ---------- Load Events ---------- */
async function loadEvents(){
  const { data } = await supabaseClient
    .from('events')
    .select('*')
    .order('created_at', { ascending:true });
  eventsList = data || [];
  renderLanding();
}

function renderLanding(){
  potluckDiv.classList.add('hidden');
  newEventBtn.style.display = 'inline-block';
  eventsDiv.innerHTML = '';

  eventsList.forEach(evt=>{
    const card = document.createElement('div');
    card.className = 'event-card';
    card.innerHTML = `<h3>${evt.name}</h3>`;

    const openBtn = document.createElement('button');
    openBtn.textContent = 'Open';
    openBtn.onclick = ()=>openEvent(evt.id);

    card.appendChild(openBtn);
    eventsDiv.appendChild(card);
  });
}

/* ---------- New Event ---------- */
newEventBtn.onclick = async ()=>{
  const name = prompt('Event name?');
  if(!name) return;

  const template = [
    { day:'Friday', slots:[{ time:'Dinner', meal_theme:'', items:[] }]},
    { day:'Saturday', slots:[
      { time:'Breakfast', meal_theme:'', items:[] },
      { time:'Dinner', meal_theme:'', items:[] }
    ]},
    { day:'Sunday', slots:[
      { time:'Breakfast', meal_theme:'', items:[] },
      { time:'Dinner', meal_theme:'', items:[] }
    ]}
  ];

  await supabaseClient.from('events').insert([{ id:uid(), name, data:template }]);
  loadEvents();
};

/* ---------- Open Event ---------- */
function openEvent(id){
  currentEvent = eventsList.find(e=>e.id===id);
  if(!currentEvent) return;

  eventsDiv.innerHTML='';
  newEventBtn.style.display='none';
  potluckDiv.innerHTML='';
  potluckDiv.classList.remove('hidden');

  const backBtn = document.createElement('button');
  backBtn.textContent='Back to Events';
  backBtn.onclick=()=>loadEvents();
  potluckDiv.appendChild(backBtn);

  const title=document.createElement('h2');
  title.textContent=currentEvent.name;
  potluckDiv.appendChild(title);

  currentEvent.data.forEach((day,dayIdx)=>{
    const dayDiv=document.createElement('div');
    dayDiv.className='day';
    dayDiv.innerHTML=`<h3>${day.day}</h3>`;

    day.slots.forEach((slot,slotIdx)=>{
      const slotDiv=document.createElement('div');
      slotDiv.className='slot';
      slotDiv.innerHTML=`<h4>${slot.time}</h4>`;

      /* --- Meal Theme Field --- */
      const themeDiv=document.createElement('div');
      themeDiv.className='meal-theme';

      const themeInput=document.createElement('input');
      themeInput.placeholder='Meal theme / notes (e.g. Dinner served at 6pm)';
      themeInput.value=slot.meal_theme||'';

      themeInput.onblur=async ()=>{
        slot.meal_theme = themeInput.value.trim();
        await saveEvent();
      };

      themeDiv.appendChild(themeInput);
      slotDiv.appendChild(themeDiv);

      /* --- Items --- */
      const itemsContainer=document.createElement('div');

      slot.items.forEach((item,itemIdx)=>{
        const itemDiv=document.createElement('div');
        itemDiv.className='item'+(item.claimed_by?'':' unclaimed');

        itemDiv.innerHTML=`
          <div class="item-content">
            <strong>${item.item}</strong>
            <span>${item.claimed_by?`by ${item.claimed_by}`:'unclaimed'}</span>
          </div>
        `;

        const btns=document.createElement('div');

        const claim=document.createElement('button');
        claim.textContent=item.claimed_by?'Unclaim':'Claim';
        claim.onclick=async ()=>{
          const name=prompt('Your name?');
          if(!name) return;
          item.claimed_by=item.claimed_by?null:name;
          await saveEvent();
          openEvent(currentEvent.id);
        };

        const del=document.createElement('button');
        del.textContent='Delete';
        del.className='danger';
        del.onclick=async ()=>{
          if(!confirm('Delete item?')) return;
          slot.items.splice(itemIdx,1);
          await saveEvent();
          openEvent(currentEvent.id);
        };

        btns.append(claim,del);
        itemDiv.appendChild(btns);
        itemsContainer.appendChild(itemDiv);
      });

      /* --- Add Item --- */
      const add=document.createElement('div');
      add.className='addItemContainer';

      const food=document.createElement('input');
      food.placeholder='Food item';

      const name=document.createElement('input');
      name.placeholder='Your name (optional)';

      const plus=document.createElement('button');
      plus.textContent='+';
      plus.className='addItem';
      plus.onclick=async ()=>{
        if(!food.value.trim()) return alert('Food required');
        slot.items.push({
          id:uid(),
          item:food.value.trim(),
          claimed_by:name.value.trim()||null
        });
        await saveEvent();
        openEvent(currentEvent.id);
      };

      add.append(food,name,plus);
      slotDiv.append(itemsContainer,add);
      dayDiv.appendChild(slotDiv);
    });

    potluckDiv.appendChild(dayDiv);
  });
}

/* ---------- Save ---------- */
async function saveEvent(){
  await supabaseClient
    .from('events')
    .update({ data: currentEvent.data })
    .eq('id', currentEvent.id);
}

/* ---------- Init ---------- */
loadEvents();
</script>

</body>
</html>
