<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Potluck Events</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>

<style>
body {
  font-family: system-ui, sans-serif;
  background:#f5f7fa;
  padding:16px;
}

h1 { margin-top:0 }

.event {
  background:#fff;
  padding:14px;
  border-radius:12px;
  margin-bottom:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

button {
  padding:8px 12px;
  border:none;
  border-radius:6px;
  background:#4f46e5;
  color:#fff;
  cursor:pointer;
}

button.secondary { background:#6b7280 }
button.danger { background:#dc2626 }

.modal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  display:none;
  align-items:center;
  justify-content:center;
}

.modal-content {
  background:#fff;
  padding:20px;
  border-radius:12px;
  max-width:320px;
  width:100%;
}
</style>
</head>

<body>

<h1>Potluck Planner</h1>

<button id="create">Create New Event</button>

<div id="list" style="margin-top:16px"></div>

<!-- Confirm Delete Modal -->
<div class="modal" id="confirmModal">
  <div class="modal-content">
    <p id="confirmText"></p>
    <button id="confirmDelete" class="danger">Delete</button>
    <button onclick="closeModal()" class="secondary">Cancel</button>
  </div>
</div>

<script>
/* ---------------- SUPABASE ---------------- */
const SUPABASE_URL = "https://amayopmpqvkqbdlkbkog.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_ANON_KEY";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ---------------- HELPERS ---------------- */
function uid(){ return Math.random().toString(36).slice(2); }

let deleteTargetId = null;

/* ---------------- LOAD EVENTS ---------------- */
async function loadEvents(){
  const { data, error } = await supabaseClient
    .from('events')
    .select('id, name')
    .order('created_at', { ascending:false });

  const list = document.getElementById('list');
  list.innerHTML = '';

  if(error){
    list.textContent = 'Failed to load events';
    console.error(error);
    return;
  }

  if(!data || data.length === 0){
    list.innerHTML = '<p>No events yet.</p>';
    return;
  }

  data.forEach(evt=>{
    const div = document.createElement('div');
    div.className = 'event';

    const link = document.createElement('a');
    link.href = `./event.html?event=${evt.id}`;
    link.textContent = evt.name;

    const del = document.createElement('button');
    del.className = 'danger';
    del.textContent = 'Delete';
    del.onclick = ()=>{
      deleteTargetId = evt.id;
      document.getElementById('confirmText').textContent =
        `Delete "${evt.name}"? This cannot be undone.`;
      openModal();
    };

    div.appendChild(link);
    div.appendChild(del);
    list.appendChild(div);
  });
}

/* ---------------- CREATE EVENT ---------------- */
document.getElementById('create').onclick = async ()=>{
  const event = {
    name: 'New Potluck Event',
    data: [
      {
        day: 'Day 1',
        notes: '',
        slots: ['Breakfast','Lunch','Dinner'].map(t=>({
          id:uid(), time:t, meal_theme:'', items:[]
        }))
      }
    ],
    locked:false
  };

  const { data, error } = await supabaseClient
    .from('events')
    .insert(event)
    .select()
    .single();

  if(error){
    alert('Failed to create event');
    console.error(error);
    return;
  }

  location.href = `./event.html?event=${data.id}`;
};

/* ---------------- DELETE EVENT ---------------- */
document.getElementById('confirmDelete').onclick = async ()=>{
  if(!deleteTargetId) return;

  const { error } = await supabaseClient
    .from('events')
    .delete()
    .eq('id', deleteTargetId);

  if(error){
    alert('Delete failed');
    console.error(error);
  }

  closeModal();
  loadEvents();
};

function openModal(){
  document.getElementById('confirmModal').style.display = 'flex';
}
function closeModal(){
  document.getElementById('confirmModal').style.display = 'none';
  deleteTargetId = null;
}

/* ---------------- INIT ---------------- */
loadEvents();
</script>

</body>
</html>
