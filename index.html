<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Clan Shangri-La Camp Meals</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: system-ui, -apple-system, sans-serif; background:#f5f7fa; margin:0; padding:12px; }
h1 { margin-top:0; }
button { padding:10px 14px; font-size:1em; cursor:pointer; background:#4f46e5; color:#fff; border:none; border-radius:6px; }
button.secondary { background:#6b7280; }
button.danger { background:#dc2626; }
.event-card { background:#fff; border-radius:12px; padding:16px; margin-bottom:16px; box-shadow:0 2px 6px rgba(0,0,0,.08); cursor:pointer; }
.event-actions { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
.admin { font-size:.85em; color:#6b7280; margin:10px 0; display:flex; flex-wrap:wrap; gap:8px; }
a { color:#4f46e5; text-decoration:none; }
</style>
</head>
<body>

<h1>Clan Shangri-La Camp Meals</h1>
<button id="newEventBtn">New Event</button>
<div id="events"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script>
const SUPABASE_URL = "https://amayopmpqvkqbdlkbkog.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtYXlvcG1wcXZrcWJkbGtia29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MTM3NTQsImV4cCI6MjA4NzM4OTc1NH0.7k5eEc3RY4COJMIvDtffwI2eGalY5k0CWARAEkuyJ-M";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

function uid(){ return Math.random().toString(36).slice(2); }

async function loadEvents(){
  const { data, error } = await supabase.from('events').select('*');
  if(error){ console.error(error); return []; }
  return data||[];
}

async function saveEvent(evt){
  const { error } = await supabase.from('events').update({
    name: evt.name,
    locked: evt.locked,
    data: evt.data
  }).eq('id', evt.id);
  if(error) console.error(error);
}

async function createNewEvent(template){
  const name = prompt('Event name?'); if(!name) return;
  const adminKey = uid();
  const { data, error } = await supabase.from('events').insert([{
    name,
    admin_key: adminKey,
    locked:false,
    data: template||[]
  }]);
  if(error) return alert(error.message);
  alert('Admin key (save this to manage the event): ' + adminKey);
  await renderLanding();
}

async function deleteEvent(evt){
  const key = prompt('Admin key?'); if(key!==evt.admin_key) return alert('Unauthorized');
  if(!confirm('Delete this event?')) return;
  const { error } = await supabase.from('events').delete().eq('id', evt.id);
  if(error) return alert(error.message);
  await renderLanding();
}

async function renameEvent(evt){
  const key = prompt('Admin key?'); if(key!==evt.admin_key) return alert('Unauthorized');
  const name = prompt('New event name?', evt.name); if(!name) return;
  evt.name = name;
  await saveEvent(evt);
  await renderLanding();
}

async function duplicateEvent(evt){
  const key = prompt('Admin key?'); if(key!==evt.admin_key) return alert('Unauthorized');
  const { error } = await supabase.from('events').insert([{
    name: evt.name+' (Copy)',
    admin_key: uid(),
    locked: evt.locked,
    data: JSON.parse(JSON.stringify(evt.data))
  }]);
  if(error) return alert(error.message);
  await renderLanding();
}

async function renderLanding(){
  const eventsDiv = document.getElementById('events');
  const events = await loadEvents();
  eventsDiv.innerHTML = '';

  events.forEach(evt => {
    const card = document.createElement('div');
    card.className = 'event-card';

    // Card content
    card.innerHTML = `
      <h3>${evt.name}</h3>
      <div class="admin">
        Share: <a href="event.html?event=${evt.id}">${location.origin + location.pathname.replace('index.html','event.html')}?event=${evt.id}</a>
      </div>
    `;

    // Clicking anywhere navigates to event
    card.addEventListener('click', (e) => {
      if(e.target.tagName.toLowerCase() === 'button' || e.target.tagName.toLowerCase() === 'a') return;
      window.location.href = `event.html?event=${evt.id}`;
    });

    // Admin buttons
    const actions = document.createElement('div');
    actions.className = 'event-actions';
    const renameBtn = document.createElement('button'); renameBtn.textContent = 'Rename'; renameBtn.className = 'secondary'; renameBtn.onclick = () => renameEvent(evt);
    const dupBtn = document.createElement('button'); dupBtn.textContent = 'Duplicate'; dupBtn.className = 'secondary'; dupBtn.onclick = () => duplicateEvent(evt);
    const delBtn = document.createElement('button'); delBtn.textContent = 'Delete'; delBtn.className = 'danger'; delBtn.onclick = () => deleteEvent(evt);
    actions.append(renameBtn, dupBtn, delBtn);
    card.appendChild(actions);

    eventsDiv.appendChild(card);
  });
}

document.getElementById('newEventBtn').addEventListener('click',()=>createNewEvent());

renderLanding();
</script>
</body>
</html>
