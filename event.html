<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Clan Shangri-La Camp Meals</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: system-ui, -apple-system, sans-serif; background:#f5f7fa; margin:0; padding:12px; }
h1,h2,h3,h4 { margin-top:0; }
button { padding:10px 14px; font-size:1em; cursor:pointer; background:#4f46e5; color:#fff; border:none; border-radius:6px; }
button.secondary { background:#6b7280; }
button.danger { background:#dc2626; }
.day { background:#fff; border-radius:12px; padding:16px; margin-bottom:20px; box-shadow:0 2px 6px rgba(0,0,0,.08); }
.slot { border-left:4px solid #4f46e5; padding-left:12px; margin-top:16px; }
.item-row { display:flex; justify-content:space-between; align-items:center; margin:6px 0; padding:6px 10px; border-radius:6px; border:1px solid #e5e7eb; }
.item-row .left { font-weight:500; }
.badge { font-size:.75em; font-weight:600; color:#fff; background:#4f46e5; padding:2px 8px; border-radius:999px; margin-left:6px; }
.addItemContainer { display:flex; gap:6px; margin-top:8px; flex-wrap:wrap; }
.addItemContainer input { flex:1; padding:8px; border-radius:6px; border:none; background:#e5e7eb; }
.admin { font-size:.85em; color:#6b7280; margin:10px 0; display:flex; flex-wrap:wrap; gap:8px; }
a { color:#4f46e5; text-decoration:none; }
</style>
</head>
<body>

<a href="./">‚Üê Back to events</a>
<h1 id="eventName"></h1>
<div id="potluck"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
<script>
const SUPABASE_URL = "https://amayopmpqvkqbdlkbkog.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtYXlvcG1wcXZrcWJkbGtia29nIiwicm9sZSI6ImF4IiwiZXhwIjoxNzgyNzc4ODAwfQ.7k5eEc3RY4COJMIvDtffwI2eGalY5k0CWARAEkuyJ-M";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

function uid(){return Math.random().toString(36).slice(2);}
function getUserId(){let id=localStorage.getItem('potluck_user_id');if(!id){id=uid();localStorage.setItem('potluck_user_id',id);}return id;}

const potluckDiv = document.getElementById('potluck');
const eventNameH1 = document.getElementById('eventName');

let currentEvent = null;

// ---------------------------
// Load event by ID
// ---------------------------
async function loadEvent(eventId){
  const { data, error } = await supabaseClient.from('events').select('*').eq('id', eventId).single();
  if(error){console.error(error); alert('Failed to load event'); return;}
  currentEvent = data;
  renderEvent();
}

// ---------------------------
// Save event
// ---------------------------
async function saveEvent(){
  const { error } = await supabaseClient.from('events').update({data: currentEvent.data}).eq('id', currentEvent.id);
  if(error){console.error(error); alert('Save failed'); return;}
  loadEvent(currentEvent.id);
}

// ---------------------------
// Render event
// ---------------------------
function renderEvent(){
  eventNameH1.textContent = currentEvent.name;
  potluckDiv.innerHTML='';

  // Admin bar
  const adminBar=document.createElement('div'); adminBar.className='admin';
  const lockBtn=document.createElement('button'); lockBtn.textContent=currentEvent.locked?'Unlock Signups':'Lock Signups'; lockBtn.className='secondary';
  lockBtn.onclick=async ()=>{
    const key=prompt('Admin key?'); if(key!==currentEvent.admin_key){alert('Unauthorized'); return;}
    const { error } = await supabaseClient.from('events').update({locked:!currentEvent.locked}).eq('id',currentEvent.id);
    if(error){console.error(error); return;}
    loadEvent(currentEvent.id);
  };
  const exportBtn=document.createElement('button'); exportBtn.textContent='Export CSV'; exportBtn.className='secondary';
  exportBtn.onclick=()=>alert('CSV export not implemented');
  adminBar.append(lockBtn,exportBtn);
  potluckDiv.appendChild(adminBar);

  // Days & Slots
  currentEvent.data.forEach(day=>{
    const dayDiv=document.createElement('div'); dayDiv.className='day'; dayDiv.innerHTML=`<h2>${day.day}</h2>`;

    day.slots.forEach(slot=>{
      const slotDiv=document.createElement('div'); slotDiv.className='slot'; slotDiv.innerHTML=`<h3>${slot.time}</h3>`;
      
      const itemsContainer=document.createElement('div'); itemsContainer.className='addItemContainer';

      // Existing items
      slot.items.forEach(item=>{
        const itemRow=document.createElement('div'); itemRow.className='item-row';
        const left=document.createElement('div'); left.className='left'; left.textContent=item.item;
        const right=document.createElement('div'); right.style.display='flex'; right.style.alignItems='center';

        if(item.claimed_by){ const badge=document.createElement('span'); badge.className='badge'; badge.textContent=item.claimed_by; right.appendChild(badge); }

        const claimBtn=document.createElement('button'); claimBtn.textContent=item.claimed_by?'Unclaim':'Claim'; claimBtn.className='secondary'; claimBtn.style.marginLeft='6px';
        claimBtn.onclick=async ()=>{
          if(!item.claimed_by){
            const name=prompt('Enter your name to claim this item:'); if(!name) return alert('Name required'); item.claimed_by=name;
          }else{ item.claimed_by=null; }
          await saveEvent();
        };
        right.appendChild(claimBtn);

        const delBtn=document.createElement('button'); delBtn.textContent='Delete'; delBtn.className='danger'; delBtn.style.marginLeft='6px';
        delBtn.onclick=async ()=>{
          if(!confirm('Delete this item?')) return;
          slot.items=slot.items.filter(i=>i!==item);
          await saveEvent();
        };
        right.appendChild(delBtn);

        itemRow.append(left,right);
        itemsContainer.appendChild(itemRow);
      });

      // Add new item
      const addRow=document.createElement('div'); addRow.className='addItemContainer';
      const addInput=document.createElement('input'); addInput.placeholder='Food item (required)';
      const addNameInput=document.createElement('input'); addNameInput.placeholder='Your name (optional)';
      const addBtn=document.createElement('button'); addBtn.textContent='+'; addBtn.onclick=async ()=>{
        if(!addInput.value.trim()) return alert('Food item required');
        slot.items.push({ id:uid(), item:addInput.value.trim(), claimed_by:addNameInput.value.trim()||null });
        await saveEvent();
      };
      addRow.append(addInput,addNameInput,addBtn);
      itemsContainer.appendChild(addRow);

      slotDiv.appendChild(itemsContainer);
      dayDiv.appendChild(slotDiv);
    });

    potluckDiv.appendChild(dayDiv);
  });
}

// ---------------------------
// Init
// ---------------------------
const params = new URLSearchParams(location.search);
if(params.get('event')) loadEvent(params.get('event'));
else potluckDiv.innerHTML='<p>No event selected.</p>';
</script>

</body>
</html>
