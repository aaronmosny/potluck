<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Camp Meal Event</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Supabase MUST load first -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
  
<style>
body { font-family: system-ui, sans-serif; background:#f5f7fa; padding:12px; }
h1,h2,h3 { margin-top:0 }
a { color:#4f46e5; text-decoration:none }
.day { background:#fff; padding:16px; margin-bottom:16px; border-radius:12px }
.slot { border-left:4px solid #4f46e5; padding-left:12px; margin-top:12px }
.item { padding:10px; margin:8px 0; border-radius:8px; background:#f9fafb }
.item.unclaimed { border:2px solid #dc2626 }
.item.you { border:2px solid #4f46e5; background:#eef2ff }
input { padding:8px; border-radius:6px; border:none; background:#e5e7eb; width:100% }
button { padding:8px 12px; border:none; border-radius:6px; background:#4f46e5; color:#fff; cursor:pointer }
button.secondary { background:#6b7280 }
.admin { font-size:.85em; color:#6b7280; margin-bottom:12px }
</style>
</head>

<body>

<a href="./">‚Üê Back to events</a>
<h1 id="title"></h1>
<div id="content"></div>

<script>
/* ---------------- SUPABASE ---------------- */
const SUPABASE_URL = "https://amayopmpqvkqbdlkbkog.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtYXlvcG1wcXZrcWJkbGtia29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MTM3NTQsImV4cCI6MjA4NzM4OTc1NH0.7k5eEc3RY4COJMIvDtffwI2eGalY5k0CWARAEkuyJ-M";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ---------------- HELPERS ---------------- */
function uid(){ return Math.random().toString(36).slice(2); }
function getUserId(){
  let id = localStorage.getItem('potluck_user_id');
  if(!id){ id = uid(); localStorage.setItem('potluck_user_id', id); }
  return id;
}

/* ---------------- LOAD EVENT ---------------- */
const params = new URLSearchParams(location.search);
const eventId = params.get('event');
if(!eventId){ alert('No event id'); }

let eventData;

async function loadEvent(){
  const { data, error } = await supabaseClient
    .from('events')
    .select('*')
    .eq('id', eventId)
    .single();

  if(error){ console.error(error); alert('Failed to load event'); return; }
  eventData = data;
  renderEvent();
}

function renderEvent(){
  document.getElementById('title').textContent = eventData.name;
  const root = document.getElementById('content');
  root.innerHTML = '';

  eventData.data.forEach(day=>{
    const dayDiv = document.createElement('div');
    dayDiv.className = 'day';
    dayDiv.innerHTML = `<h2>${day.day}</h2>`;

    day.slots.forEach(slot=>{
      const slotDiv = document.createElement('div');
      slotDiv.className = 'slot';

      const theme = document.createElement('input');
      theme.value = slot.meal_theme || '';
      theme.placeholder = 'Meal Theme';
      theme.disabled = eventData.locked;
      theme.onchange = async ()=>{
        slot.meal_theme = theme.value;
        await saveEvent();
      };

      slotDiv.innerHTML = `<h3>${slot.time}</h3>`;
      slotDiv.appendChild(theme);

      slot.items.forEach(item=>{
        const itemDiv = document.createElement('div');
        itemDiv.className = 'item ' +
          (!item.claimed_by ? 'unclaimed' : '') +
          (item.claimed_by === getUserId() ? ' you' : '');

        itemDiv.innerHTML = `
          <strong>${item.item}</strong><br>
          Suggested by: ${item.suggested_by}<br>
          ${item.claimed_by ? 'Claimed by: ' + item.claimed_by : ''}
        `;

        if(!eventData.locked){
          const btn = document.createElement('button');
          btn.textContent = item.claimed_by ? 'Unclaim' : 'Claim';
          btn.onclick = async ()=>{
            item.claimed_by = item.claimed_by ? null : getUserId();
            await saveEvent();
          };
          itemDiv.appendChild(btn);
        }

        slotDiv.appendChild(itemDiv);
      });

      if(!eventData.locked){
        const add = document.createElement('input');
        add.placeholder = 'Suggest an item and press Enter';
        add.onkeypress = async e=>{
          if(e.key === 'Enter' && add.value){
            slot.items.push({
              id: uid(),
              item: add.value,
              suggested_by: getUserId(),
              claimed_by: null,
              created_at: new Date().toISOString()
            });
            await saveEvent();
          }
        };
        slotDiv.appendChild(add);
      }

      dayDiv.appendChild(slotDiv);
    });

    root.appendChild(dayDiv);
  });
}

async function saveEvent(){
  const { error } = await supabaseClient
    .from('events')
    .update({ data: eventData.data })
    .eq('id', eventData.id);

  if(error){ console.error(error); alert('Save failed'); return; }
  loadEvent();
}

/* ---------------- INIT ---------------- */
loadEvent();
</script>
</body>
</html>
