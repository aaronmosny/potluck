<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Potluck Event</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>

<style>
body { font-family: system-ui, sans-serif; background:#f5f7fa; padding:12px; }
a { color:#4f46e5; text-decoration:none }
h1,h2,h3 { margin:0 }

.day {
  background:#fff;
  padding:16px;
  margin-bottom:16px;
  border-radius:12px;
}

.slot {
  border-left:4px solid #4f46e5;
  padding:12px;
  margin-top:12px;
  background:#fafafa;
  border-radius:8px;
}

.slot.dragging { opacity:.4 }

.slot-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.drag-handle {
  font-size:20px;
  padding:6px 10px;
  cursor:grab;
  touch-action:none;
  user-select:none;
}

.item {
  padding:8px;
  margin-top:8px;
  border-radius:6px;
  background:#f9fafb;
}

.item.unclaimed { border:2px solid #dc2626 }
.item.you { border:2px solid #4f46e5; background:#eef2ff }

input, textarea {
  width:100%;
  margin-top:8px;
  padding:8px;
  border-radius:6px;
  border:none;
  background:#e5e7eb;
}

button {
  padding:6px 10px;
  border:none;
  border-radius:6px;
  background:#4f46e5;
  color:#fff;
  cursor:pointer;
}

button.danger { background:#dc2626 }
</style>
</head>

<body>

<a href="./">← Back to events</a>
<h1 id="title"></h1>
<div id="content"></div>

<script>
/* ---------------- SUPABASE ---------------- */
const SUPABASE_URL = "https://amayopmpqvkqbdlkbkog.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtYXlvcG1wcXZrcWJkbGtia29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MTM3NTQsImV4cCI6MjA4NzM4OTc1NH0.7k5eEc3RY4COJMIvDtffwI2eGalY5k0CWARAEkuyJ-M";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ---------------- HELPERS ---------------- */
function uid(){ return Math.random().toString(36).slice(2); }

function getUserId(){
  let id = localStorage.getItem('potluck_user_id');
  if(!id){
    id = uid();
    localStorage.setItem('potluck_user_id', id);
  }
  return id;
}

const DEFAULT_SLOTS = ["Breakfast","Lunch","Dinner"];

/* ---------------- LOAD EVENT ---------------- */
const params = new URLSearchParams(location.search);
const eventId = params.get('event');

if(!eventId){
  location.href = './';
}

let eventData;

async function loadEvent(){
  const { data, error } = await supabaseClient
    .from('events')
    .select('*')
    .eq('id', eventId)
    .single();

  if(error || !data){
    console.error(error);
    location.href = './';
    return;
  }

  // Normalize structure
  data.data.forEach(day=>{
    day.notes ??= '';
    day.slots ??= DEFAULT_SLOTS.map(t=>({
      id:uid(), time:t, meal_theme:'', items:[]
    }));
  });

  eventData = data;
  render();
}

/* ---------------- RENDER ---------------- */
function render(){
  document.getElementById('title').textContent = eventData.name;
  const root = document.getElementById('content');
  root.innerHTML = '';

  eventData.data.forEach(day=>{
    const dayDiv = document.createElement('div');
    dayDiv.className = 'day';

    dayDiv.innerHTML = `<h2>${day.day}</h2>`;

    const notes = document.createElement('textarea');
    notes.placeholder = 'Day notes (e.g. Dinner served at 6pm)';
    notes.value = day.notes;
    notes.onchange = async ()=>{
      day.notes = notes.value;
      await save();
    };
    dayDiv.appendChild(notes);

    day.slots.forEach((slot, index)=>{
      const slotDiv = document.createElement('div');
      slotDiv.className = 'slot';

      slotDiv.ondragover = e=>e.preventDefault();
      slotDiv.ondrop = async e=>{
        const from = +e.dataTransfer.getData('index');
        day.slots.splice(index,0,day.slots.splice(from,1)[0]);
        await save();
      };

      const header = document.createElement('div');
      header.className = 'slot-header';

      const left = document.createElement('div');
      left.style.display = 'flex';
      left.style.alignItems = 'center';

      const handle = document.createElement('div');
      handle.className = 'drag-handle';
      handle.textContent = '☰';
      handle.draggable = true;

      handle.ondragstart = e=>{
        e.dataTransfer.setData('index', index);
        slotDiv.classList.add('dragging');
      };
      handle.ondragend = ()=>slotDiv.classList.remove('dragging');

      left.appendChild(handle);
      left.insertAdjacentHTML('beforeend', `<h3>${slot.time}</h3>`);

      const del = document.createElement('button');
      del.className = 'danger';
      del.textContent = 'Delete';
      del.onclick = async ()=>{
        if(confirm(`Delete ${slot.time}?`)){
          day.slots = day.slots.filter(s=>s.id!==slot.id);
          await save();
        }
      };

      header.appendChild(left);
      header.appendChild(del);
      slotDiv.appendChild(header);

      const theme = document.createElement('input');
      theme.placeholder = 'Meal theme';
      theme.value = slot.meal_theme || '';
      theme.onchange = async ()=>{
        slot.meal_theme = theme.value;
        await save();
      };
      slotDiv.appendChild(theme);

      slot.items.forEach(item=>{
        const itemDiv = document.createElement('div');
        itemDiv.className =
          'item ' +
          (!item.claimed_by ? 'unclaimed' : '') +
          (item.claimed_by === getUserId() ? ' you' : '');

        itemDiv.textContent = item.item;

        const btn = document.createElement('button');
        btn.textContent = item.claimed_by ? 'Unclaim' : 'Claim';
        btn.onclick = async ()=>{
          item.claimed_by = item.claimed_by ? null : getUserId();
          await save();
        };

        itemDiv.appendChild(btn);
        slotDiv.appendChild(itemDiv);
      });

      const add = document.createElement('input');
      add.placeholder = 'Add item and press Enter';
      add.onkeypress = async e=>{
        if(e.key === 'Enter' && add.value){
          slot.items.push({
            id:uid(),
            item:add.value,
            suggested_by:getUserId(),
            claimed_by:null
          });
          add.value = '';
          await save();
        }
      };

      slotDiv.appendChild(add);
      dayDiv.appendChild(slotDiv);
    });

    root.appendChild(dayDiv);
  });
}

/* ---------------- SAVE ---------------- */
async function save(){
  await supabaseClient
    .from('events')
    .update({ data:eventData.data })
    .eq('id', eventData.id);

  loadEvent();
}

loadEvent();
</script>
</body>
</html>
